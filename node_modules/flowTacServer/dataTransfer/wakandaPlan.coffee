utils              = require("flowtacCommon/utilities")
fs                 = require("fs")
oriento            = require("oriento")

oserver = null


processPlanData = (content)->
  if content.saveToDisk is true
    buf = JSON.stringify(content)
    fs.writeFileSync("C:/WorkTmp/nodeTemp/planData.txt", buf)
    console.log("Data written")
  else
    if utils.isNullish(oserver)
      oserver = oriento({
        host     : "localhost",
        port     : 2480,
        username : "root",
        password : "2yutes"
      })

    buf         = fs.readFileSync("C:/WorkTmp/nodeTemp/planData.txt")
    content     = JSON.parse(buf)
    processOpts = {
      sourceData : content,
      step       : 1,
      curIndex   : -1
    }
    continuePlanData(processOpts)
  null


continuePlanData = (opts)->
  switch opts.step
    when 1
      createOrOpenDb(opts)
    when 2
      processDataTypes(opts)
  null

createOrOpenDb = (opts)->
  if opts.sourceData.facilityId is "flowtacAdmin"
    dbName = "flowtacAdmin"
  else
    dbName = "ftAdmin_#{opts.facilityId}"

  db = oserver.use(dbName)

  if utils.isNullish(db)
    oserver.create({
      name    : dbName,
      type    : "document",
      storage : "remote"
    })
    .then((db)->
      opts.db   = db
      opts.step = 2
      continuePlanData(opts)
    )
    .catch((e)->
      console.log("error #{e}")
    )
  else
    opts.db   = db
    opts.step = 2
    continuePlanData(opts)
  null

processDataTypes = (opts)->
  console.log(opts.db.name)
  opts.db.class.create("DataType")
  .then((DataType)->
    console.log("created DataType class")
  )
  .catch((e)->
    console.log(e)
  )
  null


exports.processPlanData = processPlanData